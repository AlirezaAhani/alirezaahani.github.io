<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta charset="utf-8">
<title>Alireza's blog :: Sit in shade</title>
<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
<link rel="stylesheet" href="/public/css/styles.css">
<link rel="alternate" type="application/rss+xml" title="RSS Feed for Alireza's blog" href="https://alirezaahani.github.io/rss.xml" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">
    <meta name="description" content="Simple web app to calculate which side of vehicle to sit to minimize sun exposure.">
    <meta name="category" content="Technology, Web Development">
  </head>
  <body>
    <header>
      <h1>Alireza's blog</h1>
<nav>
    <a href="/">Index</a>
    <a href="/pages/about.html">About</a>
    <a href="https://github.com/alirezaahani">Github</a>
    <a href="/rss.xml">RSS</a>
</nav>

    </header>
    <main>
      <article>
        <div>  
          <h2>Sit in shade</h2>
          <time pubdate="pubdate">Published at: 2024/08/31 13:10:00</time>
          <span>- Category: Technology, Web Development</span> 
        </div>
        <p>Simple web app to calculate which side of vehicle to sit to minimize sun exposure.</p>
        <h3>Overview of the Application</h3>
<figure>
  <img alt="Screenshot of application" src="/public/images/sit-in-shade/webapp.png"/>
  <figcaption>Showing bus routes around میدان انقلاب, the app tells the user the perfer the left side to sit.</figcaption>
</figure>
<p>This web application tries to help users avoid sun exposure during bus travels by calculating which side of a vehicle to sit on based on the sun's position along the route. To achieve this, we combined several technologies: <a href="https://leafletjs.com/">Leaflet.js</a> for the map interface, <a href="https://www.openstreetmap.org/">OpenStreetMap (OSM)</a> for map tiles, <a href="https://www.npmjs.com/package/suncalc/v/1.0.0">SunCalc.js</a> for sun position calculations, and a Python <a href="https://flask.palletsprojects.com/en/3.0.x/">Flask</a> backend to handle route data retrieval.<br />
The app was inspired by <a href="https://sitinshade.com/">SitInShade</a>, which utilizes Google Maps for routing. However, Google Maps' public routing does not function in Iran, prompting the need for a more lcoal solution.</p>
<p>The main components are:</p>
<ol>
<li><strong>Map Interface</strong>: Uses Leaflet.js, utilizing OpenStreetMap (OSM) for map tiles.</li>
<li><strong>Sun Position Calculations</strong>: Handled by SunCalc.js, which computes the sun’s azimuth and altitude.</li>
<li><strong>Backend Integration</strong>: A Python Flask server fetches and decodes route data from <a href="https://neshan.org/">Neshan</a> Maps APIs.</li>
<li><strong>Frontend Logic</strong>: JavaScript is used to calculate vectors and determine which side of the vehicle will receive less sunlight.</li>
</ol>
<h3>Step-by-Step Breakdown</h3>
<h4>1. User Interaction and Map Interface</h4>
<p>The user starts by selecting two points: a source and a destination. This map is implemented using Leaflet.js. We used OpenStreetMap (OSM) for the map tiles, providing free and high-quality geographical data (Thank you!).</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#65737e;">// Initializing the Leaflet map centered on Tehran
</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">map </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">L</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">map</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">map</span><span style="color:#c0c5ce;">&#39;).</span><span style="color:#8fa1b3;">setView</span><span style="color:#c0c5ce;">([</span><span style="color:#d08770;">35.6892</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">51.3890</span><span style="color:#c0c5ce;">], </span><span style="color:#d08770;">13</span><span style="color:#c0c5ce;">); </span><span style="color:#65737e;">// Tehran coordinates
</span><span style="color:#c0c5ce;">  
</span><span style="color:#bf616a;">L</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">tileLayer</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png</span><span style="color:#c0c5ce;">&#39;, {
</span><span style="color:#c0c5ce;">    maxZoom: </span><span style="color:#d08770;">19</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">}).</span><span style="color:#8fa1b3;">addTo</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">  
</span><span style="color:#65737e;">// Adding markers for source and destination
</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">sourceMarker </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">L</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">marker</span><span style="color:#c0c5ce;">([</span><span style="color:#bf616a;">lat1</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">lng1</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">addTo</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">);
</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">destinationMarker </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">L</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">marker</span><span style="color:#c0c5ce;">([</span><span style="color:#bf616a;">lat2</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">lng2</span><span style="color:#c0c5ce;">]).</span><span style="color:#8fa1b3;">addTo</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">);
</span></code></pre>
<p>The user also selects their journey time, which is used in the following caculations. </p>
<h4>2. Reverse-Engineering the Neshan Maps API</h4>
<p>Here’s where things get interesting. Neshan Maps, a popular mapping service in Tehran, provides the public routing data the app needs. However, their API isn’t publicly documented, so I had to reverse-engineer (a bit of a stretch, not really &quot;Reverse-Engineering&quot;, it is easily findable in their webapp.) it to make use of it. </p>
<p>I inspected the API calls made by the Neshan Maps web app using Chrome DevTools. By monitoring the network traffic, I noticed that the API returned cryptic-ish responses for their <code>bus-routing</code> API endpoint in the <code>data</code> section. The <code>data</code> seemed base64, but after decoding did not reveal anything useful.</p>
<p>To crack this, I set up multiple breakpoints in the JavaScript debugger to intercept the request. After the trigger, I stepped through the JS code, arriving at this:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#b48ead;">const </span><span style="color:#8fa1b3;">t </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">function</span><span style="color:#c0c5ce;">(e) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">t </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">Int8Array</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">from</span><span style="color:#c0c5ce;">(window.</span><span style="color:#8fa1b3;">atob</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">), (e </span><span style="color:#b48ead;">=&gt; </span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">charCodeAt</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)))
</span><span style="color:#c0c5ce;">      , </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= new </span><span style="color:#bf616a;">Int8Array</span><span style="color:#c0c5ce;">((new </span><span style="color:#bf616a;">TextEncoder</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">https://rajman.org</span><span style="color:#c0c5ce;">&quot;))
</span><span style="color:#c0c5ce;">      , </span><span style="color:#bf616a;">n </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">t</span><span style="color:#c0c5ce;">.length
</span><span style="color:#c0c5ce;">      , </span><span style="color:#bf616a;">o </span><span style="color:#c0c5ce;">= new </span><span style="color:#bf616a;">Int8Array</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">n</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">r </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(; </span><span style="color:#bf616a;">r </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#bf616a;">n</span><span style="color:#c0c5ce;">; ++</span><span style="color:#bf616a;">r</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">o</span><span style="color:#c0c5ce;">[</span><span style="color:#bf616a;">r</span><span style="color:#c0c5ce;">] = </span><span style="color:#bf616a;">t</span><span style="color:#c0c5ce;">[</span><span style="color:#bf616a;">r</span><span style="color:#c0c5ce;">] ^ </span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">[</span><span style="color:#bf616a;">r </span><span style="color:#c0c5ce;">% </span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">.length];
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">JSON</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">parse</span><span style="color:#c0c5ce;">((new </span><span style="color:#bf616a;">TextDecoder</span><span style="color:#c0c5ce;">).</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">o</span><span style="color:#c0c5ce;">))
</span><span style="color:#c0c5ce;">}(</span><span style="color:#bf616a;">e</span><span style="color:#c0c5ce;">);
</span></code></pre>
<p>This piece of JavaScript takes a base64 encoded string (<code>e</code>), decodes it into a byte array, and then performs an XOR operation with a repeating pattern derived from the string <code>&quot;https://rajman.org&quot;</code>. The result is then parsed as a JSON object. </p>
<p>Once I understood the decoding process, I wanted to use the API directly and unfortunately I had to deal with <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>, because of this I translated the logic into Python to use Flask as a sort of API proxy:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#65737e;"># Flask route to handle bus routing requests
</span><span style="color:#c0c5ce;">@app.</span><span style="color:#bf616a;">route</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">/bus-routing</span><span style="color:#c0c5ce;">&#39;)
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">bus_routing</span><span style="color:#c0c5ce;">():
</span><span style="color:#c0c5ce;">    headers = {
</span><span style="color:#c0c5ce;">        &#39;</span><span style="color:#a3be8c;">content-type</span><span style="color:#c0c5ce;">&#39;: &#39;</span><span style="color:#a3be8c;">application/json</span><span style="color:#c0c5ce;">&#39;,
</span><span style="color:#c0c5ce;">        &#39;</span><span style="color:#a3be8c;">user-agent</span><span style="color:#c0c5ce;">&#39;: &#39;</span><span style="color:#a3be8c;">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36</span><span style="color:#c0c5ce;">&#39;,
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    response = requests.</span><span style="color:#8fa1b3;">get</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">https://neshan.org/maps/pwa-api/bus-routing/</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#bf616a;">params</span><span style="color:#c0c5ce;">=dict(request.args), </span><span style="color:#bf616a;">headers</span><span style="color:#c0c5ce;">=headers)
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;"># Decoding response similar to the JavaScript logic found in DevTools
</span><span style="color:#c0c5ce;">    t = base64.</span><span style="color:#8fa1b3;">b64decode</span><span style="color:#c0c5ce;">(response.</span><span style="color:#8fa1b3;">json</span><span style="color:#c0c5ce;">()[&#39;</span><span style="color:#a3be8c;">data</span><span style="color:#c0c5ce;">&#39;])
</span><span style="color:#c0c5ce;">    i = list(bytearray(&quot;</span><span style="color:#a3be8c;">https://rajman.org</span><span style="color:#c0c5ce;">&quot;.</span><span style="color:#8fa1b3;">encode</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&#39;)))
</span><span style="color:#c0c5ce;">    n = </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(t)
</span><span style="color:#c0c5ce;">    o = [</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] * n
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">r </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">range</span><span style="color:#c0c5ce;">(n):
</span><span style="color:#c0c5ce;">        o[r] = t[r] ^ i[r % </span><span style="color:#96b5b4;">len</span><span style="color:#c0c5ce;">(i)]
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    data = bytearray(o).</span><span style="color:#8fa1b3;">decode</span><span style="color:#c0c5ce;">(&#39;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&#39;)
</span><span style="color:#c0c5ce;">    data = json.</span><span style="color:#8fa1b3;">loads</span><span style="color:#c0c5ce;">(data)
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">jsonify</span><span style="color:#c0c5ce;">(data)
</span></code></pre>
<p>In the Python code, we decode the base64 data, then perform the XOR operation exactly as described in the JavaScript code, and finally decode the resulting byte array back into a JSON string. </p>
<h4>3. Calculating Sun Position and Vehicle Direction</h4>
<p>Once we have the route data, the next step is to calculate the sun's position at various points along the route using SunCalc.js. This library computes the sun's <a href="https://en.wikipedia.org/wiki/Horizontal_coordinate_system">azimuth (horizontal angle) and altitude (vertical angle)</a> based on geographic coordinates (Latitude and longitude) and the specified time.</p>
<p>Here’s a breakdown of how we use this data to determine the optimal side of the vehicle to sit on:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#65737e;">// JavaScript logic to calculate sun exposure along the route
</span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">let </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">j </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">; </span><span style="color:#bf616a;">i </span><span style="color:#c0c5ce;">&lt; path.length &amp;&amp; </span><span style="color:#bf616a;">j </span><span style="color:#c0c5ce;">&lt; path.length; </span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">++, </span><span style="color:#bf616a;">j</span><span style="color:#c0c5ce;">++) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">lat1 </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">radians</span><span style="color:#c0c5ce;">(path[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lat</span><span style="color:#c0c5ce;">&#39;]);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">lng1 </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">radians</span><span style="color:#c0c5ce;">(path[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lng</span><span style="color:#c0c5ce;">&#39;]);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">lat2 </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">radians</span><span style="color:#c0c5ce;">(path[</span><span style="color:#bf616a;">j</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lat</span><span style="color:#c0c5ce;">&#39;]);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">lng2 </span><span style="color:#c0c5ce;">= </span><span style="color:#8fa1b3;">radians</span><span style="color:#c0c5ce;">(path[</span><span style="color:#bf616a;">j</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lng</span><span style="color:#c0c5ce;">&#39;]);
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">sunPos </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">SunCalc</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">getPosition</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">datetime</span><span style="color:#c0c5ce;">, path[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lat</span><span style="color:#c0c5ce;">&#39;], path[</span><span style="color:#bf616a;">i</span><span style="color:#c0c5ce;">][&#39;</span><span style="color:#a3be8c;">lng</span><span style="color:#c0c5ce;">&#39;]);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">azimuth </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">sunPos</span><span style="color:#c0c5ce;">[&#39;</span><span style="color:#a3be8c;">azimuth</span><span style="color:#c0c5ce;">&#39;];
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">altitude </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">sunPos</span><span style="color:#c0c5ce;">[&#39;</span><span style="color:#a3be8c;">altitude</span><span style="color:#c0c5ce;">&#39;];
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// If the sun is below the horizon, skip this calculation
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">altitude </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) </span><span style="color:#b48ead;">continue</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Calculate the direction vector of the vehicle
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">dlng </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">lng2 </span><span style="color:#c0c5ce;">- </span><span style="color:#bf616a;">lng1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">lat2</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">dlng</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">lat1</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">lat2</span><span style="color:#c0c5ce;">) - </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">lat1</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">lat2</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">dlng</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">z </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">magnitude </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sqrt</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">** </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+ </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">** </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">vehicle_vector </span><span style="color:#c0c5ce;">= [</span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">/ </span><span style="color:#bf616a;">magnitude</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">/ </span><span style="color:#bf616a;">magnitude</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">z</span><span style="color:#c0c5ce;">];
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Calculate the direction vector of the sun
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">altitude</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">azimuth</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">altitude</span><span style="color:#c0c5ce;">) * </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">cos</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">azimuth</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">z </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sin</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">altitude</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">magnitude </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">Math</span><span style="color:#c0c5ce;">.</span><span style="color:#8fa1b3;">sqrt</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">** </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+ </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">** </span><span style="color:#d08770;">2 </span><span style="color:#c0c5ce;">+ </span><span style="color:#bf616a;">z </span><span style="color:#c0c5ce;">** </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">sun_vector </span><span style="color:#c0c5ce;">= [</span><span style="color:#bf616a;">x </span><span style="color:#c0c5ce;">/ </span><span style="color:#bf616a;">magnitude</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">y </span><span style="color:#c0c5ce;">/ </span><span style="color:#bf616a;">magnitude</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">z </span><span style="color:#c0c5ce;">/ </span><span style="color:#bf616a;">magnitude</span><span style="color:#c0c5ce;">];
</span><span style="color:#c0c5ce;">  
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Determine if the sun is on the left or right side of the vehicle
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">cross_product </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">vehicle_vector</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">] * </span><span style="color:#bf616a;">sun_vector</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] - </span><span style="color:#bf616a;">vehicle_vector</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">] * </span><span style="color:#bf616a;">sun_vector</span><span style="color:#c0c5ce;">[</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">];
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">cross_product </span><span style="color:#c0c5ce;">&gt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">left </span><span style="color:#c0c5ce;">+= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    } </span><span style="color:#b48ead;">else if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">cross_product </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">right </span><span style="color:#c0c5ce;">+= </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">;
</span><span style="color:#c0c5ce;">    }
</span><span style="color:#c0c5ce;">}
</span></code></pre>
<p>The application determines which side of the vehicle will be in the shade by calculating the relative positions of the sun and the vehicle along the selected route. This involves several mathematical computations, primarily using vectors and trigonometry.</p>
<h5>3. 1. <strong>Vehicle Direction Calculation</strong></h5>
<p>First, we calculate the direction of the vehicle between two consecutive points on the route. Let's denote two consecutive points on the path as $ P_1 = (\text{lat}_1, \text{lng}_1) $ and $ P_2 = (\text{lat}_2, \text{lng}_2) $. To compute the direction of the vehicle, we convert these geographic coordinates (latitude and longitude) to radians:</p>
<p>$$
\text{lat}_1 = \text{radians}(\text{lat}_1), \quad \text{lng}_1 = \text{radians}(\text{lng}_1)
$$</p>
<p>$$
\text{lat}_2 = \text{radians}(\text{lat}_2), \quad \text{lng}_2 = \text{radians}(\text{lng}_2)
$$</p>
<p>Next, we calculate the difference in longitude:</p>
<p>$$
\Delta \text{lng} = \text{lng}_2 - \text{lng}_1
$$</p>
<p>Using the <a href="https://en.wikipedia.org/wiki/Haversine_formula">Haversine formula</a> components, we compute the direction vector of the vehicle:</p>
<p>$$
x = \cos(\text{lat}_2) \cdot \sin(\Delta \text{lng})
$$
$$
y = \cos(\text{lat}_1) \cdot \sin(\text{lat}_2) - \sin(\text{lat}_1) \cdot \cos(\text{lat}_2) \cdot \cos(\Delta \text{lng})
$$</p>
<p>The vehicle's directional vector $ \mathbf{V} $ is then normalized:</p>
<p>$$
\mathbf{V} = \left( \frac{x}{\sqrt{x^2 + y^2}}, \frac{y}{\sqrt{x^2 + y^2}}, 0 \right)
$$</p>
<h5>3. 2. <strong>Sun Position Calculation</strong></h5>
<p>We use the SunCalc library to determine the sun's position at a specific date and time at the location $ P_1 $. The SunCalc provides the sun's azimuth ($ \theta $) and altitude ($ \alpha $) angles. The sun's position vector $ \mathbf{S} $ in 3D Cartesian coordinates is calculated as:</p>
<p>$$
x = \cos(\alpha) \cdot \sin(\theta)
$$
$$
y = \cos(\alpha) \cdot \cos(\theta)
$$
$$
z = \sin(\alpha)
$$</p>
<p>The sun's directional vector $ \mathbf{S} $ is then normalized:</p>
<p>$$
\mathbf{S} = \left( \frac{x}{\sqrt{x^2 + y^2 + z^2}}, \frac{y}{\sqrt{x^2 + y^2 + z^2}}, \frac{z}{\sqrt{x^2 + y^2 + z^2}} \right)
$$</p>
<h5>3. 3. <strong>Determining the Shaded Side</strong></h5>
<p>To determine which side of the vehicle (left or right) will be shaded, we compute the <a href="https://en.wikipedia.org/wiki/Cross_product">cross product</a> of the vehicle's directional vector $ \mathbf{V} $ and the sun's directional vector $ \mathbf{S} $:</p>
<p>$$
\mathbf{V} \times \mathbf{S} = \left( \mathbf{V}_y \cdot \mathbf{S}_z - \mathbf{V}_z \cdot \mathbf{S}_y, \mathbf{V}_z \cdot \mathbf{S}_x - \mathbf{V}_x \cdot \mathbf{S}_z, \mathbf{V}_x \cdot \mathbf{S}_y - \mathbf{V}_y \cdot \mathbf{S}_x \right)
$$</p>
<p>Since both vectors lie in the horizontal plane (where $ z = 0 $ for the vehicle vector), the cross product simplifies to:</p>
<p>$$
\mathbf{V} \times \mathbf{S} = \mathbf{V}_x \cdot \mathbf{S}_y - \mathbf{V}_y \cdot \mathbf{S}_x
$$</p>
<p>The sign of the cross product's $ z $-component determines the relative direction of the sun to the vehicle's movement:</p>
<ul>
<li>If the cross product is positive, the sun is on the right side of the vehicle.</li>
<li>If the cross product is negative, the sun is on the left side of the vehicle.</li>
</ul>
<p>By aggregating these results along the route, the application suggests which side of the vehicle (left or right) will generally be less exposed to the sun, allowing to choose the more shaded side.<br />
If the value falls within a certain threshold, it is considered equal, meaning neither side is preferred.</p>
<h4>4. Rendering Results</h4>
<p>After processing the entire route, the application aggregates the results and determines which side of the vehicle has the least sun exposure. This information is then presented to the user via popups on centers of each bus route.</p>
<h3>Limitations and Future Enhancements</h3>
<p>While the application provides useful guidance, it currently doesn’t account for foctors like real-time traffic, varying speeds, or route changes that could change the duration of route and the side of the sun. The sun's position is calculated based on fixed intervals along the route without considering these variables.</p>

      </article>
    </main>
    <footer>
      <p>Updated at: 2024/09/14 17:44:24</p>
<script>
  MathJax = {
    tex: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"],
      ],
    },
  };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js" integrity="sha512-EtUjpk/hY3NXp8vfrPUJWhepp1ZbgSI10DKPzfd+3J/p2Wo89JRBvQIdk3Q83qAEhKOiFOsYfhqFnOEv23L+dA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </footer>
  </body>
</html>